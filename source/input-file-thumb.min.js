/*
 * jQuery inputFileThumb Plugin
 *
 * Copyright (c) 2011 Novius Labs (Gilles FELIX & Antoine LEFEUVRE)
 *
 * version: 1.0.4 (06-OCT-2011)
 * @requires jQuery v1.4.4 or later
 * @optional bgiframe plugin to deal with IE z-index issues
 *
 * Examples and documentation at: http://www.novius-labs.com/contributions/jquery-plugin-inputfile/
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function($){function InputFileThumb(input,options){if(input.InputFileThumb){input.InputFileThumb.options=$.extend(input.InputFileThumb.options,options||{});input.InputFileThumb.modify(true);return}var object=this;this.openchoose=false;this.input=$(input).change(function(e){object.modify();object.hide();if($.isFunction(object.options.cbChange)){object.options.cbChange.call(object)}}).click(function(e){if($.browser.webkit&&!object.openchoose){object.openchoose=setTimeout(function(){$("body").one("mousemove",function(){object.openchoose=false;object.hide()})},500)}});this.options={};$.extend(this.options,this.defaultSettings,options||{});if(!$.isFunction(this.options.cbVisualize)&&this.options.file){this.options.cbVisualize=function(){window.open(object.options.file)}}var title=this.options.title;if(!title){title=$(input).attr("title")}if(!title){title=$(input).attr("name")}this.container=$('<span class="inputFileThumb"></span>').insertAfter(this.input);this.thumb=$('<span class="thumb"><span class="bg"></span></span>').mouseenter(function(){object.show()}).appendTo(this.container);this.hover=$('<div class="hover"></div>').mouseleave(function(){if(!$.browser.webkit||!object.openchoose){object.hide()}}).appendTo(this.container);this.fileThumb=$('<span class="fileThumb"></span>').appendTo(this.hover);this.fileDesc=$('<span class="fileDesc"><span class="fileTitle">'+title+'</span><span class="fileInfo">'+this.options.description+"</span></span>").appendTo(this.hover);this.fileActions=$('<div class="fileActions"></div>').appendTo(this.hover);this.addFile=$('<span class="addFile">'+this.options.addTitle+"</span>").appendTo(this.fileActions);this.editFile=$('<span class="editFile">'+this.options.editTitle+"</span>").appendTo(this.fileActions);if(this.options.deleteInput){this.deleteInput=$('<input type="hidden" class="deleteInput" name="'+this.options.deleteInput+'" value="" />').appendTo(this.fileActions);this.deleteFile=$('<span class="deleteFile">'+this.options.delTitle+"</span>").appendTo(this.fileActions).click(function(e){e.stopImmediatePropagation();if($.isFunction(object.options.cbDelete)){if(!object.options.cbDelete.call(object)){return false}}object.remove()})}this.modify(true);input.InputFileThumb=this;return}$.extend(InputFileThumb.prototype,{defaultSettings:{file:"",title:"",width:58,height:58,description:"",extensions:[],deleteInput:false,displayExtension:true,orientation:"",classes:"",addTitle:"Add",editTitle:"Edit",delTitle:"Delete",wrongExtensionMessage:"This extension is not allowed",cbCheckExt:false,cbVisualize:false,cbDelete:null,cbChange:null},extensionsType:{image:["gif","jpg","jpeg","png","bmp"]},iconByExtension:function(ext){this.thumb.empty().append('<span class="bg"></span>').css({"text-align":"right",cursor:"default"});var object=this;var classes=this.options.classes;if(!classes){$.each(this.extensionsType,function(type,extensionsType){var ok=false;if(object.options.extensions.length>0){ok=true;$.each(object.options.extensions,function(i,val){if($.inArray(val,extensionsType)==-1){ok=false;return true}return false})}if(ok){classes=type;return true}else{if($.inArray(ext,extensionsType)!=-1){classes=type;return true}}return false})}if(ext){var div=$("span.bg",this.thumb).addClass(classes+" on");if(this.options.displayExtension&&ext!="-"){div.append('<span class="'+ext+'">'+ext+"</span>")}}else{var div=$("span.bg",this.thumb).addClass(classes);if(this.options.displayExtension&&this.options.extensions.length==1){div.append('<span class="'+this.options.extensions[0]+'">'+this.options.extensions[0]+"</span>")}}},modify:function(init){init=init||false;var ext=false;var file=this.input.val();if(init){file=this.options.file}if(file){ext="-";var found=file.match(/.+\.(\w{2,4})(\?|$)/gi);if($.isArray(found)&&found.length){ext=RegExp.$1}if(this.options.extensions.length&&$.inArray(ext.toLowerCase(),this.options.extensions)==-1){if($.isFunction(this.options.cbCheckExt)){this.options.cbCheckExt(ext,this.options.extensions)}else{alert(this.options.wrongExtensionMessage)}this._empty();this.modify();return}this.hover.css("cursor","default");this.input.appendTo(this.editFile);this.addFile.hide();this.editFile.show();if(this.deleteInput){this.deleteInput.val("");this.deleteFile.show()}}else{this.input.appendTo(this.hover);this.hover.css("cursor","pointer");this.addFile.show();this.editFile.hide();if(this.deleteInput){this.deleteFile.hide()}}this.iconByExtension(ext);var self=this;if(init&&file&&$.inArray(ext,this.extensionsType.image)!=-1){this.thumb.empty().css({"text-align":"center",cursor:"pointer"}).width(this.options.width).height(this.options.height);var thumbSize={width:this.thumb.innerWidth(),height:this.thumb.innerHeight()};$('<img src="'+file+'" />').load(function(){var width=$(this).width();var height=$(this).height();if(height>width){if(width>thumbSize.width){$(this).width(thumbSize.width+"px")}}else{if(height>thumbSize.height){$(this).height(thumbSize.height+"px")}else{$(this).css("margin-top",(thumbSize.height-height)/2+"px")}}$(this).css({display:""}).appendTo(self.thumb)}).css({display:"none"}).appendTo($("body"))}else{this.options.cbVisualize=false;$("span.bg",this.thumb).css("line-height",this.options.height+"px").add(this.thumb).width(this.options.width).height(this.options.height)}},remove:function(){this.deleteInput.val("1");this.options.file="";this._empty();this.modify();this.hide()},_empty:function(){var temp=$("<span></span>").insertAfter(this.input);var form=$("<form></form>").appendTo("body");this.input.appendTo(form);form[0].reset();this.input.insertAfter(temp);temp.remove()},show:function(){this.hover.css({top:0,left:0,opacity:0}).show();this.fileThumb.css("float","left");this.fileDesc.css("margin-left","10px");this.fileActions.css("margin-left",(this.options.width+10)+"px");var clone=this.thumb.clone(false).appendTo(this.fileThumb);if($.isFunction(this.options.cbVisualize)){clone.bind("click",this.options.cbVisualize)}var ofst=this.thumb.offset();var left=ofst.left;var top=ofst.top;var parent=this.thumb.offsetParent().not("body");if(parent.size()){ofst=parent.offset();left-=ofst.left;top-=ofst.top}var padding={left:this.hover.css("padding-left").replace("px",""),top:this.hover.css("padding-top").replace("px",""),right:this.hover.css("padding-right").replace("px","")};if(this.options.orientation=="rtl"||(left-padding.left+this.hover.outerWidth())>$(window).width()){this.fileThumb.css("float","right");this.fileDesc.css({"margin-right":"10px","margin-left":"0px"});this.fileActions.css({"margin-right":(this.options.width+10)+"px","margin-left":"0px"});this.hover.css({top:top-padding.top,left:left+padding.right+this.thumb.outerWidth()-this.hover.outerWidth()})}else{this.hover.css({top:top-padding.top,left:left-padding.left})}if($.fn.bgiframe){this.hover.bgiframe()}this.hover.css("opacity",1)},hide:function(){$(".thumb",this.hover).remove();this.hover.hide()}});$.fn.inputFileThumb=function(options){return this.each(function(){new InputFileThumb(this,options)})}})(jQuery);
